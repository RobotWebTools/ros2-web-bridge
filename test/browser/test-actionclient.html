<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Example tests with testharness.js for Travis CI</title>
  <script src="resources/testharness.js"></script>
  <script src="resources/testharnessreport.js"></script>
  <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
</head>
<body>
  <div id="log"></div>
  <script>
    async_test(function(t) {
      var ros = new ROSLIB.Ros({url: 'ws://127.0.0.1:9090'});

      var fibonacciServer = new ROSLIB.SimpleActionServer({
        ros : ros,
        serverName : '/fibonacci',
        actionName : 'actionlib_tutorials/FibonacciAction'
      });
      fibonacciServer.on('goal', function(goalMessage) {
        fibonacciSequence = [];
        fibonacciSequence.push(0);
        fibonacciSequence.push(1);

        for (var i = 1; i < goalMessage.order; i++ ) {
          fibonacciSequence.push( fibonacciSequence[i] + fibonacciSequence[i-1] );

        if (that.canceled === true ) {
          that.fibonacciServer.setPreempted();
        }
        //send feedback
        var feedback = { sequence: fibonacciSequence };
          fibonacciServer.sendFeedback(fibonacciSequence);
        }

        //send result
        var result = { sequence: fibonacciSequence};
        fibonacciServer.setSucceeded(result);
      });
      
      var fibonacciClient = new ROSLIB.ActionClient({
        ros : ros,
        serverName : '/client_fibonacci1',
        actionName : 'actionlib_tutorials/FibonacciAction'
      });

      var goal = new ROSLIB.Goal({
        actionClient : fibonacciClient,
        goalMessage : {
          order : 7
        }
      });
      goal.on('result', t.step_func_done(function(result) {
        assert_unreached('Never reach here as ActionClient cancelled.');
      }));
      
      fibonacciClient.cancel();
      goal.send();
    }, 'ActionClient.cancel() test case 1');

    test(function() {
      var ros = new ROSLIB.Ros({url: 'ws://127.0.0.1:9090'});

      var fibonacciClient = new ROSLIB.ActionClient({
        ros : ros,
        serverName : '/client_fibonacci2',
        actionName : 'actionlib_tutorials/FibonacciAction'
      });
      var goal = new ROSLIB.Goal({
        actionClient : fibonacciClient,
        goalMessage : {
          order : 7
        }
      });
      fibonacciClient.cancel();
      fibonacciClient.cancel();
    }, 'ActionClient.cancel() test case 2');

    async_test(function(t) {
      var ros = new ROSLIB.Ros({url: 'ws://127.0.0.1:9090'});

      var fibonacciServer = new ROSLIB.SimpleActionServer({
        ros : ros,
        serverName : '/client_fibonacci3',
        actionName : 'actionlib_tutorials/FibonacciAction'
      });
      fibonacciServer.on('goal', function(goalMessage) {
        fibonacciSequence = [];
        fibonacciSequence.push(0);
        fibonacciSequence.push(1);

        for (var i = 1; i < goalMessage.order; i++ ) {
          fibonacciSequence.push( fibonacciSequence[i] + fibonacciSequence[i-1] );

        if (that.canceled === true ) {
          that.fibonacciServer.setPreempted();
        }
        //send feedback
        var feedback = { sequence: fibonacciSequence };
          fibonacciServer.sendFeedback(fibonacciSequence);
        }

        //send result
        var result = { sequence: fibonacciSequence};
        fibonacciServer.setSucceeded(result);
      });
      
      var fibonacciClient = new ROSLIB.ActionClient({
        ros : ros,
        serverName : '/client_fibonacci3',
        actionName : 'actionlib_tutorials/FibonacciAction'
      });

      var goal = new ROSLIB.Goal({
        actionClient : fibonacciClient,
        goalMessage : {
          order : 7
        }
      });
      goal.on('result', t.step_func_done(function(result) {
        assert_unreached('Never reach here as ActionClient disposed.');
      }));
      
      fibonacciClient.dispose();
      goal.send();
    }, 'ActionClient.dispose() test case 1');

    test(function() {
      var ros = new ROSLIB.Ros({url: 'ws://127.0.0.1:9090'});

      var fibonacciClient = new ROSLIB.ActionClient({
        ros : ros,
        serverName : '/client_fibonacci4',
        actionName : 'actionlib_tutorials/FibonacciAction'
      });
      var goal = new ROSLIB.Goal({
        actionClient : fibonacciClient,
        goalMessage : {
          order : 7
        }
      });
      fibonacciClient.dispose();
      fibonacciClient.dispose();
    }, 'ActionClient.dispose() test case 2');
  </script>
</body>
</html>
